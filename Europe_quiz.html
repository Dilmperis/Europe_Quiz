<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Europe Countries & Capitals Quiz</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f6f8;
      color: #222;
    }

    .container {
      width: min(1200px, 96vw);
      margin: 12px auto;
      padding: 10px;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 1.35rem;
    }

    .top-panel {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: start;
      margin-bottom: 10px;
    }

    .quiz-box {
      background: white;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
      align-items: center;
    }

    input[type="text"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      min-width: 240px;
      font-size: 1rem;
    }

    button {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      background: #2563eb;
      color: white;
    }

    button.secondary {
      background: #6b7280;
    }

    button:hover {
      opacity: 0.92;
    }

    .status {
      margin-top: 8px;
      font-weight: 600;
      min-height: 22px;
    }

    .score {
      margin-top: 6px;
      color: #333;
      font-size: 0.92rem;
    }

    #map {
      width: 100%;
      height: 72vh;
      min-height: 420px;
      max-height: 760px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .switch-wrap {
      background: white;
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #cbd5e1;
      transition: .2s;
      border-radius: 999px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      top: 3px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    input:checked + .slider {
      background-color: #10b981;
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    .hint {
      margin-top: 6px;
      color: #555;
      font-size: 0.88rem;
    }

    .small {
      font-size: 0.82rem;
      color: #666;
    }

    @media (max-width: 800px) {
      .top-panel {
        grid-template-columns: 1fr;
      }

      .switch-wrap {
        width: fit-content;
      }

      #map {
        height: 62vh;
        min-height: 380px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Europe Quiz — Countries & Capitals</h1>

    <div class="top-panel">
      <div class="quiz-box">
        <div id="question"><strong>Question:</strong> Loading...</div>
        <div class="controls">
          <input type="text" id="answerInput" placeholder="Type your answer here..." />
          <button id="submitBtn">Submit</button>
          <button id="nextBtn" class="secondary">Next</button>
        </div>
        <div class="status" id="status"></div>
        <div class="score" id="score">Score: 0 correct / 0 attempts</div>
        <div class="hint small">
          Tip: The map auto-zooms to the country. You can still pan/zoom manually.
        </div>
      </div>

      <div class="switch-wrap">
        <span class="small">Countries</span>
        <label class="switch">
          <input type="checkbox" id="modeToggle" />
          <span class="slider"></span>
        </label>
        <span class="small">Capitals</span>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <script>

    const countries = [
      { country: "Albania", capital: "Tirana", iso3: "ALB", lat: 41.3275, lon: 19.8187, size: "small" },
      { country: "Andorra", capital: "Andorra la Vella", iso3: "AND", lat: 42.5063, lon: 1.5218, size: "tiny" },
      { country: "Austria", capital: "Vienna", iso3: "AUT", lat: 48.2082, lon: 16.3738, size: "medium" },
      { country: "Belarus", capital: "Minsk", iso3: "BLR", lat: 53.9006, lon: 27.5590, size: "large" },
      { country: "Belgium", capital: "Brussels", iso3: "BEL", lat: 50.8503, lon: 4.3517, size: "small" },
      { country: "Bosnia and Herzegovina", capital: "Sarajevo", iso3: "BIH", lat: 43.8563, lon: 18.4131, size: "small" },
      { country: "Bulgaria", capital: "Sofia", iso3: "BGR", lat: 42.6977, lon: 23.3219, size: "medium" },
      { country: "Croatia", capital: "Zagreb", iso3: "HRV", lat: 45.8150, lon: 15.9819, size: "small" },
      { country: "Czech Republic", capital: "Prague", iso3: "CZE", lat: 50.0755, lon: 14.4378, size: "small" },
      { country: "Denmark", capital: "Copenhagen", iso3: "DNK", lat: 55.6761, lon: 12.5683, size: "small" },
      { country: "Estonia", capital: "Tallinn", iso3: "EST", lat: 59.4370, lon: 24.7536, size: "small" },
      { country: "Finland", capital: "Helsinki", iso3: "FIN", lat: 60.1699, lon: 24.9384, size: "large" },
      { country: "France", capital: "Paris", iso3: "FRA", lat: 48.8566, lon: 2.3522, size: "xlarge" },
      { country: "Germany", capital: "Berlin", iso3: "DEU", lat: 52.5200, lon: 13.4050, size: "xlarge" },
      { country: "Greece", capital: "Athens", iso3: "GRC", lat: 37.9838, lon: 23.7275, size: "medium" },
      { country: "Hungary", capital: "Budapest", iso3: "HUN", lat: 47.4979, lon: 19.0402, size: "small" },
      { country: "Iceland", capital: "Reykjavik", iso3: "ISL", lat: 64.1466, lon: -21.9426, size: "large" },
      { country: "Ireland", capital: "Dublin", iso3: "IRL", lat: 53.3498, lon: -6.2603, size: "medium" },
      { country: "Italy", capital: "Rome", iso3: "ITA", lat: 41.9028, lon: 12.4964, size: "large" },
      { country: "Kosovo", capital: "Pristina", iso3: "XKX", lat: 42.6629, lon: 21.1655, size: "tiny" },
      { country: "Latvia", capital: "Riga", iso3: "LVA", lat: 56.9496, lon: 24.1052, size: "small" },
      { country: "Liechtenstein", capital: "Vaduz", iso3: "LIE", lat: 47.1410, lon: 9.5209, size: "tiny" },
      { country: "Lithuania", capital: "Vilnius", iso3: "LTU", lat: 54.6872, lon: 25.2797, size: "small" },
      { country: "Luxembourg", capital: "Luxembourg", iso3: "LUX", lat: 49.6116, lon: 6.1319, size: "tiny" },
      { country: "Malta", capital: "Valletta", iso3: "MLT", lat: 35.8989, lon: 14.5146, size: "tiny" },
      { country: "Moldova", capital: "Chișinău", iso3: "MDA", lat: 47.0105, lon: 28.8638, size: "small" },
      { country: "Monaco", capital: "Monaco", iso3: "MCO", lat: 43.7384, lon: 7.4246, size: "tiny" },
      { country: "Montenegro", capital: "Podgorica", iso3: "MNE", lat: 42.4304, lon: 19.2594, size: "tiny" },
      { country: "Netherlands", capital: "Amsterdam", iso3: "NLD", lat: 52.3676, lon: 4.9041, size: "small" },
      { country: "North Macedonia", capital: "Skopje", iso3: "MKD", lat: 41.9973, lon: 21.4280, size: "tiny" },
      { country: "Norway", capital: "Oslo", iso3: "NOR", lat: 59.9139, lon: 10.7522, size: "xlarge" },
      { country: "Poland", capital: "Warsaw", iso3: "POL", lat: 52.2297, lon: 21.0122, size: "large" },
      { country: "Portugal", capital: "Lisbon", iso3: "PRT", lat: 38.7223, lon: -9.1393, size: "medium" },
      { country: "Romania", capital: "Bucharest", iso3: "ROU", lat: 44.4268, lon: 26.1025, size: "large" },
      { country: "San Marino", capital: "San Marino", iso3: "SMR", lat: 43.9424, lon: 12.4578, size: "tiny" },
      { country: "Serbia", capital: "Belgrade", iso3: "SRB", lat: 44.7866, lon: 20.4489, size: "medium" },
      { country: "Slovakia", capital: "Bratislava", iso3: "SVK", lat: 48.1486, lon: 17.1077, size: "small" },
      { country: "Slovenia", capital: "Ljubljana", iso3: "SVN", lat: 46.0569, lon: 14.5058, size: "tiny" },
      { country: "Spain", capital: "Madrid", iso3: "ESP", lat: 40.4168, lon: -3.7038, size: "xlarge" },
      { country: "Sweden", capital: "Stockholm", iso3: "SWE", lat: 59.3293, lon: 18.0686, size: "xlarge" },
      { country: "Switzerland", capital: "Bern", iso3: "CHE", lat: 46.9480, lon: 7.4474, size: "small" },
      { country: "Ukraine", capital: "Kyiv", iso3: "UKR", lat: 50.4501, lon: 30.5234, size: "xlarge" },
      { country: "United Kingdom", capital: "London", iso3: "GBR", lat: 51.5072, lon: -0.1276, size: "xlarge" },
      { country: "Vatican City", capital: "Vatican City", iso3: "VAT", lat: 41.9029, lon: 12.4534, size: "tiny" }
    ];

    let mode = "country";
    let current = null;
    let correct = 0;
    let attempts = 0;
    let autoNextTimer = null;

    let forceViewResetToken = 0;

    let currentView = {
      lonMin: -25, lonMax: 45,
      latMin: 34, latMax: 72
    };

    const questionEl = document.getElementById("question");
    const statusEl = document.getElementById("status");
    const scoreEl = document.getElementById("score");
    const inputEl = document.getElementById("answerInput");
    const modeToggle = document.getElementById("modeToggle");

    function normalize(str) {
      return str
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9 ]/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function getZoomWindow(country) {
      const presets = {
        tiny:   { lonHalf: 2.2, latHalf: 1.6 },
        small:  { lonHalf: 4.5, latHalf: 3.0 },
        medium: { lonHalf: 7.5, latHalf: 5.0 },
        large:  { lonHalf: 10.5, latHalf: 7.0 },
        xlarge: { lonHalf: 14.0, latHalf: 9.5 }
      };
      const p = presets[country.size] || presets.medium;

      const latFactor = Math.max(0.75, Math.cos((country.lat * Math.PI) / 180));
      const lonHalfAdjusted = p.lonHalf / latFactor;

      return {
        lonMin: clamp(country.lon - lonHalfAdjusted, -30, 50),
        lonMax: clamp(country.lon + lonHalfAdjusted, -30, 50),
        latMin: clamp(country.lat - p.latHalf, 30, 75),
        latMax: clamp(country.lat + p.latHalf, 30, 75)
      };
    }

    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    function pointIsInView(lat, lon, view) {
      return lon >= view.lonMin && lon <= view.lonMax && lat >= view.latMin && lat <= view.latMax;
    }

    function shouldShowBackArrow(country, view) {
      const inView = pointIsInView(country.lat, country.lon, view);
      const lonSpan = Math.abs(view.lonMax - view.lonMin);
      const latSpan = Math.abs(view.latMax - view.latMin);

      const tooZoomedOutForSmall =
        (country.size === "tiny" && (lonSpan > 14 || latSpan > 10)) ||
        (country.size === "small" && (lonSpan > 22 || latSpan > 15));

      return !inView || tooZoomedOutForSmall;
    }

    function arrowPositionTowardTarget(country, view) {
      const cLon = (view.lonMin + view.lonMax) / 2;
      const cLat = (view.latMin + view.latMax) / 2;

      const dx = country.lon - cLon;
      const dy = country.lat - cLat;

      const lonMargin = (view.lonMax - view.lonMin) * 0.08;
      const latMargin = (view.latMax - view.latMin) * 0.08;

      let lon = clamp(country.lon, view.lonMin + lonMargin, view.lonMax - lonMargin);
      let lat = clamp(country.lat, view.latMin + latMargin, view.latMax - latMargin);

      if (pointIsInView(country.lat, country.lon, view)) {
        lon = view.lonMin + lonMargin * 1.8;
        lat = view.latMax - latMargin * 1.8;
      }

      let symbol = "⬅";
      if (Math.abs(dx) > Math.abs(dy)) {
        symbol = dx > 0 ? "➡" : "⬅";
      } else {
        symbol = dy > 0 ? "⬆" : "⬇";
      }

      if (!pointIsInView(country.lat, country.lon, view)) {
        if (dx > 0 && dy > 0) symbol = "↗";
        if (dx > 0 && dy < 0) symbol = "↘";
        if (dx < 0 && dy > 0) symbol = "↖";
        if (dx < 0 && dy < 0) symbol = "↙";
      }

      return { lat, lon, symbol };
    }

    function baseMapTrace(highlightIso3) {
      const locations = countries.map(c => c.iso3);
      const values = countries.map(c => (c.iso3 === highlightIso3 ? 2 : 1));
      const texts = countries.map(c => `${c.country} — ${c.capital}`);

      return {
        type: "choropleth",
        locationmode: "ISO-3",
        locations,
        z: values,
        text: texts,
        hovertemplate: "%{text}<extra></extra>",
        colorscale: [
          [0, "#cbd5e1"],
          [0.49, "#cbd5e1"],
          [0.5, "#f59e0b"],
          [1, "#f59e0b"]
        ],
        zmin: 1,
        zmax: 2,
        marker: { line: { color: "#ffffff", width: 0.6 } },
        showscale: false
      };
    }

    function drawMap(highlightIso3 = null, options = {}) {
      const { view = null } = options;
      const traces = [baseMapTrace(highlightIso3)];

      if (current && shouldShowBackArrow(current, currentView)) {
        const arrow = arrowPositionTowardTarget(current, currentView);
        traces.push({
          type: "scattergeo",
          mode: "text",
          lat: [arrow.lat],
          lon: [arrow.lon],
          text: [arrow.symbol],
          textfont: { size: 22, color: "#dc2626" },
          hovertemplate: `Go back to ${current.country}<extra></extra>`,
          showlegend: false
        });
      }

      const layout = {
        margin: { t: 4, r: 4, b: 4, l: 4 },
        uirevision: `view-${forceViewResetToken}`,
        geo: {
          scope: "europe",
          showland: true,
          landcolor: "#e5e7eb",
          showcountries: true,
          countrycolor: "#ffffff",
          coastlinecolor: "#ffffff",
          bgcolor: "rgba(0,0,0,0)",
          lakecolor: "#dbeafe",
          showlakes: true,
          projection: { type: "mercator" }
        }
      };

      if (view) {
        layout.geo.lonaxis = { range: [view.lonMin, view.lonMax] };
        layout.geo.lataxis = { range: [view.latMin, view.latMax] };
        currentView = { ...view };
      } else {
        layout.geo.lonaxis = { range: [currentView.lonMin, currentView.lonMax] };
        layout.geo.lataxis = { range: [currentView.latMin, currentView.latMax] };
      }

      Plotly.react("map", traces, layout, {
        responsive: true,
        displayModeBar: false,
        scrollZoom: true
      });
    }

    function autoZoomToCurrentCountry() {
      if (!current) return;
      const view = getZoomWindow(current);

      forceViewResetToken++;

      drawMap(current.iso3, { view });
    }

    function nextQuestion() {
      if (autoNextTimer) {
        clearTimeout(autoNextTimer);
        autoNextTimer = null;
      }

      current = countries[Math.floor(Math.random() * countries.length)];
      statusEl.textContent = "";
      inputEl.value = "";
      inputEl.focus();

      if (mode === "country") {
        questionEl.innerHTML = `<strong>Question:</strong> What country is highlighted on the map?`;
      } else {
        questionEl.innerHTML = `<strong>Question:</strong> What is the capital of the highlighted country?`;
      }

      autoZoomToCurrentCountry();
    }

    function submitAnswer() {
      if (!current) return;

      const userAnswer = normalize(inputEl.value);
      if (!userAnswer) return;

      attempts++;

      const expected = mode === "country" ? current.country : current.capital;
      const expectedNorm = normalize(expected);

      if (userAnswer === expectedNorm) {
        correct++;
        statusEl.textContent = "Correct!";
        statusEl.style.color = "#059669";
        scoreEl.textContent = `Score: ${correct} correct / ${attempts} attempts`;

        // Keep same logic: auto-advance after correct answer
        autoNextTimer = setTimeout(() => nextQuestion(), mode === "capital" ? 650 : 450);
      } else {
        statusEl.textContent = `Incorrect. Correct answer: ${expected}`;
        statusEl.style.color = "#dc2626";
        scoreEl.textContent = `Score: ${correct} correct / ${attempts} attempts`;
      }
    }

    modeToggle.addEventListener("change", () => {
      mode = modeToggle.checked ? "capital" : "country";
      statusEl.textContent = "";
      nextQuestion();
    });

    document.getElementById("submitBtn").addEventListener("click", submitAnswer);
    document.getElementById("nextBtn").addEventListener("click", nextQuestion);

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitAnswer();
    });

    // Track user manual zoom/pan and redraw arrow reminder if needed
    const mapDiv = document.getElementById("map");
    mapDiv.addEventListener("plotly_relayout", (ev) => {
      const lon0 = ev["geo.lonaxis.range[0]"];
      const lon1 = ev["geo.lonaxis.range[1]"];
      const lat0 = ev["geo.lataxis.range[0]"];
      const lat1 = ev["geo.lataxis.range[1]"];

      if (
        typeof lon0 === "number" && typeof lon1 === "number" &&
        typeof lat0 === "number" && typeof lat1 === "number"
      ) {
        currentView = {
          lonMin: Math.min(lon0, lon1),
          lonMax: Math.max(lon0, lon1),
          latMin: Math.min(lat0, lat1),
          latMax: Math.max(lat0, lat1)
        };

        // Redraw only if arrow visibility may have changed
        if (current) {
          drawMap(current.iso3); // keeps user's current zoom because no new view is passed
        }
      }
    });

    // Start with a Europe-wide view
    currentView = { lonMin: -25, lonMax: 45, latMin: 34, latMax: 72 };
    drawMap(null, { view: currentView });
    nextQuestion();

    window.addEventListener("resize", () => {
      Plotly.Plots.resize("map");
    });
  </script>
</body>
</html>